stages:
  - build
  - test
  - package
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  LATEST_TAG: $CI_REGISTRY_IMAGE:latest

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository/

# Build EAR
build:
  stage: build
  image: maven:3.9-eclipse-temurin-11
  script:
    - mvn $MAVEN_CLI_OPTS clean package -DskipTests -s ci_settings.xml
  artifacts:
    paths:
      - "tbd-internal-ear/target/*.ear"
      - "tbd-internal-war/target/*.war"
    expire_in: 1 day

# Run tests
test:
  stage: test
  image: maven:3.9-eclipse-temurin-11
  script:
    - mvn $MAVEN_CLI_OPTS test -s ci_settings.xml
  artifacts:
    reports:
      junit:
        - "**/target/surefire-reports/TEST-*.xml"
    paths:
      - "**/target/surefire-reports/"
    expire_in: 1 week

# Build Docker image
package:
  stage: package
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $IMAGE_TAG -f docker/Dockerfile .
    - docker push $IMAGE_TAG
    - docker tag $IMAGE_TAG $LATEST_TAG
    - docker push $LATEST_TAG
  only:
    - main
    - tags
  dependencies:
    - build

# Deploy to DEV
deploy-dev:
  stage: deploy
  image: amazon/aws-cli:latest
  before_script:
    - apk add --no-cache curl jq
    - aws --version
  script:
    - echo "Deploying to DEV environment"
    # Update ECS service with new image
    - |
      aws ecs update-service \
        --cluster tbd-dev-cluster \
        --service tbd-internal-service \
        --force-new-deployment \
        --region $AWS_REGION
  environment:
    name: development
    url: https://dev-internal.example.com
  only:
    - main
  when: manual

# Deploy to PROD
deploy-prod:
  stage: deploy
  image: amazon/aws-cli:latest
  before_script:
    - apk add --no-cache curl jq
    - aws --version
  script:
    - echo "Deploying to PROD environment"
    # Tag image for production
    - docker pull $IMAGE_TAG
    - docker tag $IMAGE_TAG $CI_REGISTRY_IMAGE:prod-$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE:prod-$CI_COMMIT_SHORT_SHA
    # Update ECS service
    - |
      aws ecs update-service \
        --cluster tbd-prod-cluster \
        --service tbd-internal-service \
        --force-new-deployment \
        --region $AWS_REGION
  environment:
    name: production
    url: https://internal.example.com
  only:
    - tags
  when: manual
