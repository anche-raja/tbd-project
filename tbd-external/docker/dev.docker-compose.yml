version: '3.8'

services:
  liberty-dev:
    image: icr.io/appcafe/websphere-liberty:24.0.0.12-full-java8-openj9-ubi
    container_name: tbd-external-dev
    ports:
      - "9080:9080"    # HTTP
      - "9443:9443"    # HTTPS
      - "7777:7777"    # Debug port
    environment:
      # Database configuration (from .env or defaults)
      DB_URL: ${DB_URL:-jdbc:oracle:thin:@oracle-db:1521:ORCL}
      DB_USERNAME: ${DB_USERNAME:-tbd_user}
      DB_PASSWORD: ${DB_PASSWORD:-change_me}
      DB_POOL_SIZE: ${DB_POOL_SIZE:-10}
      
      # Debug configuration
      WLP_DEBUG_ADDRESS: "*:7777"
      WLP_DEBUG_SUSPEND: "n"
      
      # Liberty configuration
      LOG_DIR: /logs
      WLP_LOGGING_CONSOLE_LOGLEVEL: INFO
      WLP_LOGGING_CONSOLE_FORMAT: simple
    volumes:
      # Mount EAR file for hot reload
      - ../tbd-external-ear/target/tbd-external.ear:/config/apps/tbd-external.ear:ro
      
      # Mount server configuration
      - ../liberty/server.xml:/config/server.xml:ro
      
      # Mount Oracle JDBC driver
      - ./ojdbc8.jar:/config/lib/ojdbc8.jar:ro
      
      # Mount logs for viewing
      - liberty-dev-logs:/logs
    networks:
      - tbd-network
    depends_on:
      - oracle-db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9080/external/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Oracle Database (for local development/testing)
  oracle-db:
    image: gvenzl/oracle-xe:21-slim-faststart
    container_name: tbd-oracle-dev
    ports:
      - "1521:1521"
    environment:
      ORACLE_PASSWORD: ${ORACLE_PASSWORD:-OraclePass123}
      APP_USER: ${DB_USERNAME:-tbd_user}
      APP_USER_PASSWORD: ${DB_PASSWORD:-change_me}
    volumes:
      - oracle-dev-data:/opt/oracle/oradata
      - ./init-scripts:/container-entrypoint-initdb.d:ro
    networks:
      - tbd-network
    healthcheck:
      test: ["CMD", "healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

volumes:
  liberty-dev-logs:
    driver: local
  oracle-dev-data:
    driver: local

networks:
  tbd-network:
    driver: bridge
